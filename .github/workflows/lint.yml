name: Linting

on:
  pull_request:
    branches:
      - main
      - develop
  push:
    branches:
      - main
      - develop

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  detect-changes:
    name: Detect Changed Services
    runs-on: ubuntu-latest
    outputs:
      frontend: ${{ steps.filter.outputs.frontend }}
      platform: ${{ steps.filter.outputs.platform }}
      agent: ${{ steps.filter.outputs.agent }}
      docs: ${{ steps.filter.outputs.docs }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for service changes
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            frontend:
              - 'frontend/**'
              - 'package.json'
              - 'tsconfig.json'
              - '.eslintrc.*'
              - '.prettierrc.*'
            platform:
              - 'platform/**'
              - 'requirements.txt'
              - 'pyproject.toml'
              - 'setup.py'
            agent:
              - 'agent/**'
              - 'go.mod'
              - 'go.sum'
            docs:
              - '**.md'
              - 'docs/**'

  lint-frontend:
    name: Lint Frontend
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.frontend == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'frontend/package-lock.json'

      - name: Install dependencies
        working-directory: ./frontend
        run: npm ci

      - name: Run ESLint
        working-directory: ./frontend
        run: npm run lint

      - name: Run Prettier
        working-directory: ./frontend
        run: npm run format:check

      - name: TypeScript Check
        working-directory: ./frontend
        run: npm run type-check

  lint-platform:
    name: Lint Platform Service
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.platform == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: 'platform/requirements.txt'

      - name: Install dependencies
        working-directory: ./platform
        run: |
          pip install --upgrade pip
          pip install ruff

      - name: Run Ruff (linting)
        working-directory: ./platform
        run: ruff check .

      - name: Run Ruff (formatting)
        working-directory: ./platform
        run: ruff format --check .

  lint-agent:
    name: Lint Agent Service
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.agent == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'
          cache-dependency-path: 'agent/go.sum'

      - name: Install golangci-lint
        run: |
          curl -sSfL https://raw.githubusercontent.com/golangci/golangci-lint/master/install.sh | sh -s -- -b $(go env GOPATH)/bin v1.55.2

      - name: Run golangci-lint
        working-directory: ./agent
        run: golangci-lint run --timeout=5m

      - name: Run go fmt
        working-directory: ./agent
        run: |
          if [ -n "$(gofmt -l .)" ]; then
            echo "Go files must be formatted with gofmt. Run: gofmt -w ."
            gofmt -l .
            exit 1
          fi

      - name: Run go vet
        working-directory: ./agent
        run: go vet ./...

  lint-markdown:
    name: Lint Markdown
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.docs == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Lint Markdown files
        uses: DavidAnson/markdownlint-cli2-action@v15
        with:
          globs: |
            **/*.md
            !node_modules/**
            !**/node_modules/**

  summary:
    name: Linting Summary
    runs-on: ubuntu-latest
    needs: [detect-changes, lint-frontend, lint-platform, lint-agent, lint-markdown]
    if: always()

    steps:
      - name: Check linting results
        run: |
          FAILED=0
          
          if [ "${{ needs.lint-frontend.result }}" == "failure" ]; then
            echo "::error::Frontend linting failed"
            FAILED=1
          fi
          
          if [ "${{ needs.lint-platform.result }}" == "failure" ]; then
            echo "::error::Platform service linting failed"
            FAILED=1
          fi
          
          if [ "${{ needs.lint-agent.result }}" == "failure" ]; then
            echo "::error::Agent service linting failed"
            FAILED=1
          fi
          
          if [ "${{ needs.lint-markdown.result }}" == "failure" ]; then
            echo "::error::Markdown linting failed"
            FAILED=1
          fi
          
          if [ $FAILED -eq 1 ]; then
            exit 1
          fi
          
          echo "âœ“ All linting checks passed!"
